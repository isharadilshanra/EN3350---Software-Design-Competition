
cloud_range is the public varible that reflect the user current consumption rate (varies between 2 to 8)

############################################# Update the cloud_range once per 10 sec ####################################################

using System.Collections;
using UnityEngine;
using UnityEngine.Networking;

public class PlayerAuthentication : MonoBehaviour
{
    public string apiKey = "NjVkNDIyMjNmMjc3NmU3OTI5MWJmZGI1OjY1ZDQyMjIzZjI3NzZlNzkyOTFiZmRhYg";
    public string loginEndpoint = "http://20.15.114.131:8080/api/login";
    public string consumptionEndpoint = "http://20.15.114.131:8080/api/power-consumption/current/view";
    private string token;

    public float cloud_range;  // Public variable to be accessed by other scripts

    private float previousConsumption = -1;  // Initialize to -1 to indicate no previous value
    private const float checkInterval = 10f;  // Interval to check the API value

    void Start()
    {
        // Start the authentication process
        StartCoroutine(GetToken());
    }

    // Method to fetch JWT token
    public IEnumerator GetToken()
    {
        using (UnityWebRequest request = UnityWebRequest.Post(loginEndpoint, new WWWForm()))
        {
            request.SetRequestHeader("Content-Type", "application/json");
            byte[] bodyRaw = System.Text.Encoding.UTF8.GetBytes("{\"apiKey\": \"" + apiKey + "\"}");
            request.uploadHandler = new UploadHandlerRaw(bodyRaw);
            request.downloadHandler = new DownloadHandlerBuffer();

            yield return request.SendWebRequest();

            if (request.result == UnityWebRequest.Result.Success)
            {
                // Extract token from JSON response
                string jsonResponse = request.downloadHandler.text;
                TokenResponse response = JsonUtility.FromJson<TokenResponse>(jsonResponse);
                token = response.token;
                Debug.Log("Token fetched: " + token);

                // Start fetching power consumption data
                StartCoroutine(FetchConsumptionData());
            }
            else
            {
                Debug.LogError("Failed to fetch token: " + request.error);
            }
        }
    }

    // Method to fetch power consumption data
    private IEnumerator FetchConsumptionData()
    {
        while (true)
        {
            using (UnityWebRequest request = UnityWebRequest.Get(consumptionEndpoint))
            {
                request.SetRequestHeader("Authorization", "Bearer " + token);
                yield return request.SendWebRequest();

                if (request.result == UnityWebRequest.Result.Success)
                {
                    string jsonResponse = request.downloadHandler.text;
                    ConsumptionResponse response = JsonUtility.FromJson<ConsumptionResponse>(jsonResponse);
                    Debug.Log("Current Consumption: " + response.currentConsumption);


                    // Calculate rate of change if previous value exists
                    if (previousConsumption >= 0)
                    {
                        float rateOfChange = response.currentConsumption - previousConsumption;
                        UpdateCloudRange(rateOfChange);
                        Debug.Log("Updated Cloud Range: " + cloud_range);
                    }

                    // Update previous consumption value
                    previousConsumption = response.currentConsumption;
                }
                else
                {
                    Debug.LogError("Failed to fetch consumption data: " + request.error);
                }

                // Wait for the defined interval before the next request
                yield return new WaitForSeconds(checkInterval);
            }
        }
    }

    // Method to update cloud_range based on rate of change
    private void UpdateCloudRange(float rateOfChange)
    {
        float absRate = Mathf.Abs(rateOfChange);  // Use absolute value for mapping
        if (absRate >= 0 && absRate <= 0.25f)
        {
            cloud_range = 8;
        }
        else if (absRate > 0.25f && absRate <= 0.5f)
        {
            cloud_range = 7;
        }
        else if (absRate > 0.5f && absRate <= 0.75f)
        {
            cloud_range = 6;
        }
        else if (absRate > 0.75f && absRate <= 1f)
        {
            cloud_range = 5;
        }
        else if (absRate > 1f && absRate <= 1.25f)
        {
            cloud_range = 4;
        }
        else if (absRate > 1.25f && absRate <= 1.5f)
        {
            cloud_range = 3;
        }
        else if (absRate > 1.5f && absRate <= 1.75f)
        {
            cloud_range = 2;
        }
        else
        {
            // Handle unexpected large rates
            Debug.LogError("Unexpected rate of change: " + rateOfChange);
            cloud_range = 2;  // Set to a minimum range value for safety
        }
        Debug.Log("Updated Cloud Range: " + cloud_range);
    }

    private class TokenResponse
    {
        public string token;
    }

    private class ConsumptionResponse
    {
        public float currentConsumption;
    }
}




################################################### Update the cloud_range variable once per 3 iderations (30 sec)###################################################

using System.Collections;
using UnityEngine;
using UnityEngine.Networking;

public class PlayerAuthentication : MonoBehaviour
{
    public string apiKey = "NjVkNDIyMjNmMjc3NmU3OTI5MWJmZGI1OjY1ZDQyMjIzZjI3NzZlNzkyOTFiZmRhYg";
    public string loginEndpoint = "http://20.15.114.131:8080/api/login";
    public string consumptionEndpoint = "http://20.15.114.131:8080/api/power-consumption/current/view";
    private string token;

    public float cloud_range;  // Public variable to be accessed by other scripts

    private float previousConsumption = -1;  // Initialize to -1 to indicate no previous value
    private const float checkInterval = 10f;  // Interval to check the API value
    private const float updateInterval = 30f;  // Interval to update the cloud range
    private float nextUpdateTime = 0f;  // Next time to update the cloud range

    void Start()
    {
        // Start the authentication process
        StartCoroutine(GetToken());
    }

    // Method to fetch JWT token
    public IEnumerator GetToken()
    {
        using (UnityWebRequest request = UnityWebRequest.Post(loginEndpoint, new WWWForm()))
        {
            request.SetRequestHeader("Content-Type", "application/json");
            byte[] bodyRaw = System.Text.Encoding.UTF8.GetBytes("{\"apiKey\": \"" + apiKey + "\"}");
            request.uploadHandler = new UploadHandlerRaw(bodyRaw);
            request.downloadHandler = new DownloadHandlerBuffer();

            yield return request.SendWebRequest();

            if (request.result == UnityWebRequest.Result.Success)
            {
                // Extract token from JSON response
                string jsonResponse = request.downloadHandler.text;
                TokenResponse response = JsonUtility.FromJson<TokenResponse>(jsonResponse);
                token = response.token;
                Debug.Log("Token fetched: " + token);

                // Start fetching power consumption data
                StartCoroutine(FetchConsumptionData());
            }
            else
            {
                Debug.LogError("Failed to fetch token: " + request.error);
            }
        }
    }

    // Method to fetch power consumption data
    private IEnumerator FetchConsumptionData()
    {
        while (true)
        {
            using (UnityWebRequest request = UnityWebRequest.Get(consumptionEndpoint))
            {
                request.SetRequestHeader("Authorization", "Bearer " + token);
                yield return request.SendWebRequest();

                if (request.result == UnityWebRequest.Result.Success)
                {
                    string jsonResponse = request.downloadHandler.text;
                    ConsumptionResponse response = JsonUtility.FromJson<ConsumptionResponse>(jsonResponse);
                    Debug.Log("Current Consumption: " + response.currentConsumption);

                    // Calculate rate of change if previous value exists
                    if (previousConsumption >= 0)
                    {
                        float rateOfChange = response.currentConsumption - previousConsumption;

                        // Update cloud range if the update interval has passed
                        if (Time.time >= nextUpdateTime)
                        {
                            UpdateCloudRange(rateOfChange);
                            Debug.Log("Updated Cloud Range: " + cloud_range);
                            nextUpdateTime = Time.time + updateInterval;  // Set the next update time
                        }
                    }

                    // Update previous consumption value
                    previousConsumption = response.currentConsumption;
                }
                else
                {
                    Debug.LogError("Failed to fetch consumption data: " + request.error);
                }

                // Wait for the defined interval before the next request
                yield return new WaitForSeconds(checkInterval);
            }
        }
    }

    // Method to update cloud_range based on rate of change
    private void UpdateCloudRange(float rateOfChange)
    {
        float absRate = Mathf.Abs(rateOfChange);  // Use absolute value for mapping
        if (absRate >= 0 && absRate <= 0.2f)
        {
            cloud_range = 8;
        }
        else if (absRate > 0.2f && absRate <= 0.4f)
        {
            cloud_range = 7;
        }
        else if (absRate > 0.4f && absRate <= 0.6f)
        {
            cloud_range = 6;
        }
        else if (absRate > 0.6f && absRate <= 0.8f)
        {
            cloud_range = 5;
        }
        else if (absRate > 0.8f && absRate <= 1f)
        {
            cloud_range = 4;
        }
        else if (absRate > 1f && absRate <= 1.2f)
        {
            cloud_range = 3;
        }
        else if (absRate > 1.2f && absRate <= 1.4f)
        {
            cloud_range = 2;
        }
        else
        {
            // Handle unexpected large rates
            Debug.LogError("Unexpected rate of change: " + rateOfChange);
            cloud_range = 2;  // Set to a minimum range value for safety
        }

    }

    private class TokenResponse
    {
        public string token;
    }

    private class ConsumptionResponse
    {
        public float currentConsumption;
    }
}
